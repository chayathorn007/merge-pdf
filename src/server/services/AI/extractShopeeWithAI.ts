import { config } from "dotenv";
config(); 

import { OpenAI } from "openai";
import fs from "fs";
import path from "path";

// ‚úÖ Interface ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å AI
export interface ExtractedData {
  order: string;
  recipient: string;
  sender: string;
}

// ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á client ‡∏î‡πâ‡∏ß‡∏¢ API key (with fallback ‡πÅ‡∏•‡∏∞ timeout)
let openai: OpenAI | null = null;

try {
  if (process.env.OPENAI_API_KEY && process.env.OPENAI_API_KEY !== "sk-placeholder-key-for-development") {
    openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
      timeout: 60000, // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ timeout 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OpenAI API
      maxRetries: 2, // ‚úÖ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    });
  } else {
    console.warn("‚ö†Ô∏è OpenAI API key not found or is placeholder. AI features will be disabled.");
  }
} catch (error) {
  console.warn("‚ö†Ô∏è Failed to initialize OpenAI client:", error);
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á ```json ... ``` ‡∏ó‡∏µ‡πà GPT ‡∏ä‡∏≠‡∏ö‡∏ï‡∏≠‡∏ö‡∏°‡∏≤
function stripMarkdownJson(input: string): string {
  return input
    .replace(/^```json\s*/i, "") // ‡∏ï‡∏±‡∏î ```json ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    .replace(/^```\s*/i, "")     // ‡∏ï‡∏±‡∏î ``` ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏î‡∏î ‡πÜ ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    .replace(/```$/i, "")        // ‡∏ï‡∏±‡∏î ``` ‡∏ó‡πâ‡∏≤‡∏¢
    .trim();
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å - ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout handling
export async function extractShopeeWithAI(text: string): Promise<ExtractedData[]> {
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ OpenAI client ‡πÉ‡∏´‡πâ return mock data
  if (!openai) {
    console.warn("‚ö†Ô∏è OpenAI not available, returning mock data");
    return [
      {
        order: "MOCK123",
        recipient: "‡∏ô‡∏≤‡∏¢ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö 123 ‡∏´‡∏°‡∏π‡πà 1 ‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ 10540 Tel: 081-234-5678",
        sender: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏¥‡∏à‡∏Å‡∏ô‡∏Å ‡∏à‡∏≥‡∏Å‡∏±‡∏î 91-93-95 ‡∏ã‡∏≠‡∏¢‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å 29, ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡πÄ‡∏Ç‡∏ï‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ 10170"
      }
    ];
  }

  const prompt =
`‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô AI ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF ‡πÅ‡∏•‡∏∞‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:
1. ‡∏´‡∏≤ Order Number/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô Order No, Order Number, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå, ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠, Shopee Order No.‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
2. ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•, ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£) ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
3. ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•, ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£) ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
 - **‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏ä‡πà‡∏ô "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏¥‡∏à‡∏Å‡∏ô‡∏Å ‡∏à‡∏≥‡∏Å‡∏±‡∏î" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ã‡∏≠‡∏¢‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å 29" ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÄ‡∏ä‡πà‡∏ô "91-93-95 ‡∏ã‡∏≠‡∏¢‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å29" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏Ç‡∏ï‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô"**
‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON Array ‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ:
5. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ã‡∏≠‡∏¢" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ñ‡∏ô‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÅ‡∏Ç‡∏ß‡∏á" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏Ç‡∏ï" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà"‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô

[
  {
    "order": "ABC123",
    "recipient": "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢ ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ 123 ‡∏´‡∏°‡∏π‡πà 1 ‡∏ï‡∏≥‡∏ö‡∏•‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ 10540 Tel: 081-234-5678",
    "sender":"‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏¥‡∏à‡∏Å‡∏ô‡∏Å ‡∏à‡∏≥‡∏Å‡∏±‡∏î 91-93-95 ‡∏ã‡∏≠‡∏¢‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å 29, ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡πÄ‡∏Ç‡∏ï‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ 10170"
  },
  {‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    "order": "XYZ789", 
    "recipient": "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏°‡∏≤‡∏•‡∏µ ‡∏£‡∏±‡∏Å‡∏î‡∏µ 456 ‡∏ã‡∏≠‡∏¢ 5 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡πÅ‡∏Ç‡∏ß‡∏á‡∏Ñ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ô ‡πÄ‡∏Ç‡∏ï‡∏ß‡∏±‡∏í‡∏ô‡∏≤ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10110",
    "sender":"‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏¥‡∏à‡∏Å‡∏ô‡∏Å ‡∏à‡∏≥‡∏Å‡∏±‡∏î 91-93-95 ‡∏ã‡∏≠‡∏¢‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å 29, ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡πÄ‡∏Ç‡∏ï‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ 10170"
  },
    {
    "order": "123456", 
    "recipient": "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏°‡∏≤‡∏•‡∏µ ‡∏£‡∏±‡∏Å‡∏î‡∏µ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 5/4 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 4, ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏î, ‡∏ï‡πç‡∏≤‡∏ö‡∏• ‡∏ï‡∏Å‡∏û‡∏£‡∏°, ‡∏≠‡πç‡∏≤‡πÄ‡∏†‡∏≠‡∏Ç‡∏•‡∏∏‡∏á, ‡∏ï‡πç‡∏≤‡∏ö‡∏•‡∏ï‡∏Å‡∏û‡∏£‡∏°, ‡∏≠‡πç‡∏≤‡πÄ‡∏†‡∏≠‡∏Ç‡∏•‡∏∏‡∏á, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£ 22110",
    "sender":"‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏¥‡∏à‡∏Å‡∏ô‡∏Å ‡∏à‡∏≥‡∏Å‡∏±‡∏î 91-93-95 ‡∏ã‡∏≠‡∏¢‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å 29, ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡πÄ‡∏Ç‡∏ï‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ 10170"
  },
    {
    "order": "123456", 
    "recipient": "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏°‡∏≤‡∏•‡∏µ ‡∏£‡∏±‡∏Å‡∏î‡∏µ ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 5/4 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 4, ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏î, ‡∏ï‡πç‡∏≤‡∏ö‡∏• ‡∏ï‡∏Å‡∏û‡∏£‡∏°, ‡∏≠‡πç‡∏≤‡πÄ‡∏†‡∏≠‡∏Ç‡∏•‡∏∏‡∏á, ‡∏ï‡πç‡∏≤‡∏ö‡∏•‡∏ï‡∏Å‡∏û‡∏£‡∏°, ‡∏≠‡πç‡∏≤‡πÄ‡∏†‡∏≠‡∏Ç‡∏•‡∏∏‡∏á, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ 22110",
    "sender":"‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏¥‡∏à‡∏Å‡∏ô‡∏Å ‡∏à‡∏≥‡∏Å‡∏±‡∏î 91-93-95 ‡∏ã‡∏≠‡∏¢‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å 29, ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡πÄ‡∏Ç‡∏ï‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ 10170"
  },

  

]

‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
- ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ã‡∏≠‡∏¢" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ñ‡∏ô‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÅ‡∏Ç‡∏ß‡∏á" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏Ç‡∏ï" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà"‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
- ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÉ‡∏´‡πâ return ‡πÄ‡∏õ‡πá‡∏ô string
- ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏™‡∏±‡∏ö‡∏™‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á tracking number ‡∏Å‡∏±‡∏ö order number

‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:
"""
${text}
"""
`;

  try {
    console.log("ü§ñ Starting AI processing...");
    const startTime = Date.now();
    
    // ‚úÖ ‡πÉ‡∏ä‡πâ Promise.race ‡πÄ‡∏û‡∏∑‡πà‡∏≠ timeout handling ‡πÅ‡∏ö‡∏ö custom
    const timeoutPromise = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('AI processing timeout after 50 seconds')), 50000);
    });

    const apiPromise = openai.chat.completions.create({
      model: "gpt-4o-mini", // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å
      messages: [
        {
          role: "system",
          content: "You are a helpful assistant for extracting structured shipping data from Thai e-commerce receipts.",
        },
        { role: "user", content: prompt },
      ],
      temperature: 0.2,
    });

    const completion = await Promise.race([apiPromise, timeoutPromise]) as any;
    const processingTime = Date.now() - startTime;
    console.log(`‚è±Ô∏è AI processing completed in ${processingTime}ms`);

    const resultText = completion.choices[0].message.content || "";
    console.log("üì¶ AI raw response:\n", resultText);
    const cleaned = stripMarkdownJson(resultText);

    console.log("üì¶ AI cleaned JSON:\n", cleaned);

    const data = JSON.parse(cleaned);
    return Array.isArray(data) ? data : [];

  } catch (e: any) {
    console.error("‚ùå AI processing error:\n", e.message || e);
    
    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô timeout ‡∏´‡∏£‡∏∑‡∏≠ AI error ‡πÉ‡∏´‡πâ return mock data ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ
    if (e.message?.includes('timeout') || e.message?.includes('API')) {
      console.warn("‚ö†Ô∏è AI timeout/error, falling back to mock data");
      return [
        {
          order: `FALLBACK_${Date.now()}`,
          recipient: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô",
          sender: "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏¥‡∏à‡∏Å‡∏ô‡∏Å ‡∏à‡∏≥‡∏Å‡∏±‡∏î 91-93-95 ‡∏ã‡∏≠‡∏¢‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å 29, ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡πÄ‡∏Ç‡∏ï‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ 10170"
        }
      ];
    }
    
    return [];
  }
}
